# v0.5.4 发布说明

**发布日期**: 2025年12月09日

## 版本概述

v0.5.4 版本主要聚焦于附件管理功能的完善和认证系统的安全优化，为需求、任务、Bug、版本等核心模块添加了完整的附件管理功能，并优化了JWT认证机制的安全性和并发处理能力。

## 主要更新

### 新功能 ✨

#### 附件管理功能增强
- **需求附件管理**
  - 支持在需求详情页面上传、下载、删除附件
  - 附件列表显示文件名称、大小、上传时间
  - 支持附件预览和下载

- **任务附件管理**
  - 支持在任务详情页面上传、下载、删除附件
  - 附件列表显示文件名称、大小、上传时间
  - 支持附件预览和下载

- **Bug附件管理**
  - 修复并完善Bug附件管理功能
  - 支持上传、下载、删除和彻底删除文件
  - 附件列表显示文件名称、大小、上传时间

- **版本附件管理**
  - 支持在版本详情页面上传、下载、删除附件
  - 附件列表显示文件名称、大小、上传时间
  - 支持附件预览和下载

#### 版本管理优化
- **版本详情组件封装**
  - 将版本详情内容封装为独立组件 `VersionDetailContent.vue`
  - 减少代码重复，提高可维护性
  - 统一版本详情页面的显示逻辑

### 安全优化 🔐

#### JWT认证系统增强
- **Token类型验证**
  - 在JWT Claims中添加 `TokenType` 字段，区分 access token 和 refresh token
  - 刷新Token接口验证token类型，确保只能使用 refresh token 刷新
  - 防止使用 access token 进行刷新操作，提升安全性

- **刷新Token并发处理优化**
  - 优化刷新token的并发处理机制
  - 所有并发请求共享同一个刷新操作，避免重复刷新
  - 确保多个请求同时收到401错误时，只发送一次刷新请求
  - 所有等待的请求都能获取到新的token并自动重试

- **自动刷新机制优化**
  - 修复token失效时未自动调用刷新的问题
  - 支持业务错误码401的自动刷新处理
  - 优化错误处理逻辑，避免重复显示错误消息
  - 防止重复调用logout函数

### 代码优化 🛠️

#### 后端代码重构
- **微信配置读取逻辑提取**
  - 将微信配置读取逻辑提取为私有方法 `loadWeChatConfig()`
  - 减少代码重复，提高可维护性
  - 统一配置读取逻辑，便于后续维护

#### 前端代码优化
- **错误处理优化**
  - 提取跳转登录逻辑为 `redirectToLogin()` 函数
  - 消除重复的跳转代码
  - 添加防重复跳转机制，避免并发请求时重复显示错误消息

- **TypeScript类型修复**
  - 修复 `request.ts` 中 refreshTokenPromise 的类型定义
  - 修复 `VersionDetailContent.vue` 中未使用的导入
  - 修复 `VersionDetail.vue` 中未使用的导入

### 测试增强 🧪

- **JWT单元测试**
  - 新增 `backend/pkg/auth/jwt_test.go` 测试文件
  - 添加Token类型验证测试
  - 添加RefreshToken和AccessToken差异测试
  - 添加Token解析和验证测试

- **认证功能测试**
  - 在 `auth_test.go` 中添加使用access token刷新被拒绝的测试用例
  - 完善刷新Token功能的测试覆盖

## 技术细节

### 数据库变更
- 无数据库结构变更（附件管理使用现有的 `attachments` 表和关联表）

### API变更
- 无破坏性API变更
- 刷新Token接口增加token类型验证（向后兼容）

### 涉及文件

#### 后端
- `backend/pkg/auth/jwt.go` - JWT生成和解析逻辑，添加Token类型
- `backend/pkg/auth/jwt_test.go` - JWT单元测试（新增）
- `backend/internal/api/auth.go` - 认证API，提取微信配置读取逻辑
- `backend/internal/api/attachment.go` - 附件API增强
- `backend/internal/api/bug.go` - Bug附件管理
- `backend/internal/api/requirement.go` - 需求附件管理
- `backend/internal/api/task.go` - 任务附件管理
- `backend/internal/api/version.go` - 版本附件管理
- `backend/tests/unit/auth_test.go` - 认证功能测试增强

#### 前端
- `frontend/src/utils/request.ts` - 请求拦截器，优化刷新token和错误处理
- `frontend/src/stores/auth.ts` - 认证状态管理，添加防重复logout
- `frontend/src/api/auth.ts` - 认证API接口
- `frontend/src/components/AttachmentUpload.vue` - 附件上传组件增强
- `frontend/src/components/VersionDetailContent.vue` - 版本详情内容组件（新增）
- `frontend/src/components/BugDetailContent.vue` - Bug详情内容组件，添加附件管理
- `frontend/src/components/RequirementDetailContent.vue` - 需求详情内容组件，添加附件管理
- `frontend/src/components/TaskDetailContent.vue` - 任务详情内容组件，添加附件管理
- `frontend/src/views/auth/Login.vue` - 登录页面优化
- `frontend/src/views/version/VersionDetail.vue` - 版本详情页面重构
- `frontend/src/views/bug/BugDetail.vue` - Bug详情页面，添加附件管理
- `frontend/src/views/requirement/RequirementDetail.vue` - 需求详情页面，添加附件管理
- `frontend/src/views/task/TaskDetail.vue` - 任务详情页面，添加附件管理

## 升级说明

### 升级步骤
1. **更新代码**：拉取最新代码
2. **前端更新**：需要重新构建前端
   ```bash
   cd frontend
   npm install  # 如果需要更新依赖
   npm run build
   ```
3. **后端更新**：需要重新编译后端
   ```bash
   cd backend
   go build -o server cmd/server/main.go
   ```
4. **数据库更新**：无需数据库迁移（GORM AutoMigrate会自动处理）

### 兼容性
- **向后兼容**：完全兼容 v0.5.3
- **API兼容**：所有API保持向后兼容
- **数据兼容**：无需数据迁移

### 注意事项
- 本次更新优化了认证系统的安全性，建议所有用户升级
- 附件管理功能已全面支持，建议在升级后测试附件上传和下载功能
- 刷新Token机制已优化，用户体验将得到提升

## 统计信息

- **修改文件数**：37个文件
- **新增代码**：2325行
- **删除代码**：484行
- **净增代码**：1841行

---

**版本号**: v0.5.4  
**发布日期**: 2025年12月09日  
**兼容性**: 向后兼容 v0.5.3  
**建议升级**: ✅ 是（包含安全优化和重要功能增强）

