# v0.4.1 发布说明

**发布日期**: 2025年11月27日

## 版本概述

v0.4.1 版本主要增强了数据迁移工具的功能，添加了从禅道迁移历史记录的能力，并修复了迁移工具中用户密码更新的问题。

## 主要更新

### 1. 历史记录迁移功能 ✨

为数据迁移工具添加了完整的历史记录迁移能力：

- **操作历史记录迁移**：从禅道的 `zt_action` 表迁移操作历史记录到 `actions` 表
- **字段变更历史记录迁移**：从禅道的 `zt_history` 表迁移字段变更历史到 `histories` 表
- **自动ID映射**：正确关联迁移后的实体ID（项目、需求、任务、Bug、版本）
- **操作类型转换**：自动将禅道的操作类型转换为系统操作类型
- **字段值处理**：使用 `ProcessHistory` 自动处理用户ID、枚举值等转换

**支持的对象类型**：
- ✅ 需求（story → requirement）
- ✅ 任务（task → task）
- ✅ Bug（bug → bug）
- ✅ 项目（project → project）
- ✅ 版本（build → version）

**迁移顺序**：
1. 先迁移所有实体（部门、角色、用户、项目、需求、任务、Bug、版本）
2. 然后迁移操作历史记录（依赖所有实体）
3. 最后迁移字段变更历史记录（依赖操作历史记录）

### 2. 迁移工具密码修复 🔧

修复了迁移工具中用户密码更新的问题：

- **问题**：如果用户已存在（如系统初始化时创建的admin用户），迁移工具会跳过创建，但不会更新密码，导致密码不是默认的"123"
- **修复**：迁移工具现在会更新已存在用户的密码为默认密码"123"
- **影响**：确保所有迁移的用户（包括已存在的admin用户）都使用统一的默认密码

## 技术实现

### 后端

1. **ID映射维护**
   - 添加了 `taskIDMap` 和 `bugIDMap` 用于维护任务和Bug的ID映射
   - 添加了 `actionIDMap` 用于维护操作记录的ID映射

2. **映射函数**（`mapper.go`）
   - `ConvertZenTaoObjectType`：转换禅道对象类型
   - `ConvertZenTaoAction`：转换禅道操作类型

3. **迁移函数**（`migrator.go`）
   - `MigrateActions`：迁移操作历史记录
   - `MigrateHistories`：迁移字段变更历史记录
   - 改进 `MigrateTasks` 和 `MigrateBugs`：维护ID映射
   - 改进 `MigrateUsers`：更新已存在用户的密码

## 数据安全

**重要说明**：迁移工具采用只读模式访问禅道数据库，不会修改禅道数据库的任何数据。

- ✅ 所有对禅道数据库的操作都是只读查询（`Find`、`First`、`Where`）
- ✅ 所有写操作都针对目标数据库（goproject）
- ✅ 可以安全地在生产环境的禅道数据库上运行

## 使用指南

### 迁移历史记录

历史记录迁移会自动在所有实体迁移完成后执行：

```bash
cd backend
go run cmd/migrate/main.go -config cmd/migrate/migrate-config.yaml
```

迁移工具会按照以下顺序执行：
1. 部门
2. 角色和权限
3. 用户
4. 项目
5. 项目模块
6. 版本
7. 需求
8. 任务
9. Bug
10. 项目成员
11. **操作历史记录**（新增）
12. **字段变更历史记录**（新增）

### 迁移后的密码

- 所有迁移的用户（包括已存在的用户）的密码都设置为 **`123`**
- 首次登录后请立即修改密码
- 如果admin用户已存在，迁移工具会自动更新其密码为"123"

## 更新内容

### 新增文件

无

### 修改文件

**后端**：
- `backend/cmd/migrate/migrator.go` - 添加历史记录迁移功能和密码更新逻辑
- `backend/cmd/migrate/mapper.go` - 添加对象类型和操作类型映射函数
- `backend/cmd/migrate/README.md` - 更新文档，添加历史记录迁移说明

## 已知问题

无

## 后续计划

- 继续完善单元测试覆盖率
- 优化历史记录迁移性能
- 支持更多数据类型的迁移

## 升级指南

### 从 v0.4.0 升级

1. **代码更新**：拉取最新代码
2. **重新迁移**（可选）：如果需要迁移历史记录，重新运行迁移工具
3. **密码重置**：如果之前迁移的用户密码不正确，重新运行迁移工具会自动更新密码

### 注意事项

- 历史记录迁移需要在所有实体迁移完成后进行
- 如果某个实体的操作记录无法匹配（如对象ID不存在），会跳过并记录日志
- 字段变更历史记录会自动使用 `ProcessHistory` 进行格式化处理
- 迁移工具不会修改禅道数据库的任何数据，可以安全使用

## 致谢

感谢所有贡献者的支持和反馈！

---

**下载地址**: [GitHub Releases](https://github.com/funnywwh/goproject/releases/tag/v0.4.1)

