# 测试管理详细设计文档

## 1. 概述

测试管理系统用于管理项目的测试用例、跟踪测试执行情况、记录测试结果、关联测试发现的Bug，以及进行测试统计和覆盖率分析。系统支持测试单创建、更新、状态管理、多测试类型、测试结果记录，以及测试统计功能。

**注意：** 当前实现中，测试报告功能已合并到测试单中，测试单包含测试结果（result）和测试摘要（summary）字段，用于记录测试执行情况。

## 2. 功能特性

### 2.1 测试单管理

- **测试单CRUD**：创建、查看、更新、删除测试单
- **测试单状态管理**：支持测试单状态流转（待评审、正常、被阻塞、研究中）
- **测试类型管理**：支持多种测试类型（功能测试、性能测试、安全测试等）
- **测试步骤**：支持Markdown格式的测试步骤
- **测试结果**：支持记录测试结果（通过、失败、阻塞）
- **测试摘要**：支持记录测试摘要
- **Bug关联**：支持测试单关联发现的Bug（多对多关系）
- **测试筛选**：支持按项目、状态、类型、创建人筛选

### 2.2 测试统计

- **总体统计**：统计测试单总数、各状态数量、通过率、失败率
- **按项目统计**：按项目统计测试单数量、通过率、失败率
- **按类型统计**：按测试类型统计测试单数量、通过率、失败率
- **覆盖率分析**：分析测试覆盖率

## 3. 数据模型

### 3.1 测试单表（test_cases）

```go
type TestCase struct {
    ID        uint           `gorm:"primarykey" json:"id"`
    CreatedAt time.Time      `json:"created_at"`
    UpdatedAt time.Time      `json:"updated_at"`
    DeletedAt gorm.DeletedAt `gorm:"index" json:"-"`

    Name        string      `gorm:"size:200;not null" json:"name"`        // 测试单名称
    Description string      `gorm:"type:text" json:"description"`         // 测试描述
    TestSteps   string      `gorm:"type:text" json:"test_steps"`          // 测试步骤（Markdown）
    Types       StringArray  `gorm:"type:text" json:"types"`                // 测试类型（多选）：functional, performance, security, etc. (JSON数组)
    Status      string       `gorm:"size:20;default:'wait'" json:"status"` // 状态：wait(待评审), normal(正常), blocked(被阻塞), investigate(研究中)
    Result      string       `gorm:"size:20" json:"result"`                 // 测试结果：passed, failed, blocked（合并自TestReport）
    Summary     string       `gorm:"type:text" json:"summary"`              // 测试摘要（合并自TestReport）

    ProjectID uint    `gorm:"index;not null" json:"project_id"`
    Project   Project `gorm:"foreignKey:ProjectID" json:"project,omitempty"`

    CreatorID uint `gorm:"index" json:"creator_id"`
    Creator   User `gorm:"foreignKey:CreatorID" json:"creator,omitempty"`

    Bugs    []Bug        `gorm:"many2many:test_case_bugs;" json:"bugs,omitempty"`
}
```

**字段说明：**

- `Name`：测试单名称，必填，最大长度200字符
- `Description`：测试描述，可选，用于描述测试目的和范围
- `TestSteps`：测试步骤，可选，支持Markdown格式，用于记录详细的测试步骤
- `Types`：测试类型，可选，JSON数组格式，支持多选
  - `functional`：功能测试
  - `performance`：性能测试
  - `security`：安全测试
  - `integration`：集成测试
  - `unit`：单元测试
  - `ui`：UI测试
  - `api`：API测试
  - 其他自定义类型
- `Status`：测试单状态，默认值为"wait"（待评审）
  - `wait`：待评审（测试单已创建，等待评审）
  - `normal`：正常（测试单已评审通过，可以执行）
  - `blocked`：被阻塞（测试单被阻塞，无法执行）
  - `investigate`：研究中（测试单需要进一步研究）
- `Result`：测试结果，可选
  - `passed`：通过（测试通过）
  - `failed`：失败（测试失败）
  - `blocked`：阻塞（测试被阻塞）
- `Summary`：测试摘要，可选，用于记录测试执行摘要
- `ProjectID`：关联的项目ID，必填
- `CreatorID`：创建人ID，必填
- `Bugs`：关联的Bug列表（多对多）

### 3.2 测试单-Bug关联表（test_case_bugs）

测试单和Bug的多对多关联表，用于记录测试单发现的Bug。

**表结构：**

- `test_case_id`：测试单ID（主键）
- `bug_id`：BugID（主键）
- `created_at`：创建时间

## 4. API设计

### 4.1 测试单管理API

#### 4.1.1 获取测试单列表

**接口：** `GET /api/test-cases`

**权限：** `test-case:read`

**查询参数：**

- `keyword`：搜索关键词（名称、描述、测试步骤）
- `project_id`：项目ID
- `status`：测试单状态
- `type`：测试类型
- `creator_id`：创建人ID
- `page`：页码，默认1
- `size`：每页数量，默认10

**响应示例：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "name": "用户登录功能测试",
        "description": "测试用户登录功能",
        "test_steps": "1. 打开登录页面\n2. 输入用户名和密码\n3. 点击登录按钮",
        "types": ["functional", "ui"],
        "status": "normal",
        "result": "passed",
        "summary": "测试通过，登录功能正常",
        "project_id": 1,
        "project": {
          "id": 1,
          "name": "项目名称"
        },
        "creator_id": 1,
        "creator": {
          "id": 1,
          "username": "user1",
          "nickname": "用户1"
        },
        "bugs": [
          {
            "id": 1,
            "title": "登录按钮点击无响应"
          }
        ],
        "created_at": "2024-01-01T00:00:00Z",
        "updated_at": "2024-01-15T00:00:00Z"
      }
    ],
    "total": 100,
    "page": 1,
    "page_size": 10
  }
}
```

#### 4.1.2 获取测试单详情

**接口：** `GET /api/test-cases/:id`

**权限：** `test-case:read`

**响应示例：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "name": "用户登录功能测试",
    "description": "测试用户登录功能",
    "test_steps": "1. 打开登录页面\n2. 输入用户名和密码\n3. 点击登录按钮",
    "types": ["functional", "ui"],
    "status": "normal",
    "result": "passed",
    "summary": "测试通过，登录功能正常",
    "project_id": 1,
    "project": {
      "id": 1,
      "name": "项目名称",
      "code": "PROJECT001"
    },
    "creator_id": 1,
    "creator": {
      "id": 1,
      "username": "user1",
      "nickname": "用户1"
    },
    "bugs": [
      {
        "id": 1,
        "title": "登录按钮点击无响应",
        "status": "closed"
      }
    ],
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-15T00:00:00Z"
  }
}
```

#### 4.1.3 创建测试单

**接口：** `POST /api/test-cases`

**权限：** `test-case:create`

**请求体：**

```json
{
  "name": "用户登录功能测试",
  "description": "测试用户登录功能",
  "test_steps": "1. 打开登录页面\n2. 输入用户名和密码\n3. 点击登录按钮",
  "types": ["functional", "ui"],
  "status": "wait",
  "result": "",
  "summary": "",
  "project_id": 1,
  "bug_ids": [1, 2]
}
```

**字段说明：**

- `name`：测试单名称，必填
- `description`：测试描述，可选
- `test_steps`：测试步骤，可选，支持Markdown格式
- `types`：测试类型数组，可选
- `status`：测试单状态，可选，默认值为"wait"
- `result`：测试结果，可选
- `summary`：测试摘要，可选
- `project_id`：项目ID，必填
- `bug_ids`：关联的BugID列表，可选

**响应示例：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "name": "用户登录功能测试",
    "description": "测试用户登录功能",
    "test_steps": "1. 打开登录页面\n2. 输入用户名和密码\n3. 点击登录按钮",
    "types": ["functional", "ui"],
    "status": "wait",
    "result": "",
    "summary": "",
    "project_id": 1,
    "project": {
      "id": 1,
      "name": "项目名称"
    },
    "creator_id": 1,
    "creator": {
      "id": 1,
      "username": "user1",
      "nickname": "用户1"
    },
    "bugs": [
      {
        "id": 1,
        "title": "Bug1"
      },
      {
        "id": 2,
        "title": "Bug2"
      }
    ],
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-01T00:00:00Z"
  }
}
```

#### 4.1.4 更新测试单

**接口：** `PUT /api/test-cases/:id`

**权限：** `test-case:update`

**请求体：**

```json
{
  "name": "更新后的测试单名称",
  "description": "更新后的测试描述",
  "test_steps": "更新后的测试步骤",
  "types": ["functional", "performance"],
  "status": "normal",
  "result": "passed",
  "summary": "测试通过",
  "bug_ids": [1, 2, 3]
}
```

**说明：**

- 更新测试单时，可以更新所有字段
- 更新关联的Bug时，使用新的ID列表替换原有关联

#### 4.1.5 删除测试单

**接口：** `DELETE /api/test-cases/:id`

**权限：** `test-case:delete`

**响应示例：**

```json
{
  "code": 200,
  "message": "删除成功"
}
```

#### 4.1.6 更新测试单状态

**接口：** `PUT /api/test-cases/:id/status`

**权限：** `test-case:update`

**请求体：**

```json
{
  "status": "normal"
}
```

**状态流转规则：**

- `wait` → `normal`：测试单评审通过
- `wait` → `blocked`：测试单被阻塞
- `wait` → `investigate`：测试单需要研究
- `normal` → `blocked`：测试单被阻塞
- `normal` → `investigate`：测试单需要研究
- `blocked` → `normal`：测试单解除阻塞
- `investigate` → `normal`：测试单研究完成

### 4.2 测试统计API

#### 4.2.1 获取测试单统计

**接口：** `GET /api/test-cases/statistics`

**权限：** `test-case:read`

**查询参数：**

- `project_id`：项目ID（可选）
- `keyword`：搜索关键词（可选）

**响应示例：**

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 100,
    "wait": 10,
    "normal": 60,
    "blocked": 5,
    "investigate": 5,
    "passed": 70,
    "failed": 20,
    "pass_rate": 70.0,
    "fail_rate": 20.0,
    "project_stats": [
      {
        "project_id": 1,
        "project_name": "项目1",
        "total": 50,
        "passed": 35,
        "failed": 10,
        "pass_rate": 70.0
      },
      {
        "project_id": 2,
        "project_name": "项目2",
        "total": 50,
        "passed": 35,
        "failed": 10,
        "pass_rate": 70.0
      }
    ],
    "type_stats": [
      {
        "type": "functional",
        "total": 60,
        "passed": 45,
        "failed": 10,
        "pass_rate": 75.0
      },
      {
        "type": "performance",
        "total": 20,
        "passed": 15,
        "failed": 5,
        "pass_rate": 75.0
      },
      {
        "type": "security",
        "total": 20,
        "passed": 10,
        "failed": 5,
        "pass_rate": 50.0
      }
    ]
  }
}
```

**统计说明：**

- `total`：测试单总数
- `wait`：待评审数量
- `normal`：正常数量
- `blocked`：被阻塞数量
- `investigate`：研究中数量
- `passed`：通过数量（根据result字段统计）
- `failed`：失败数量（根据result字段统计）
- `pass_rate`：通过率（passed / total * 100）
- `fail_rate`：失败率（failed / total * 100）
- `project_stats`：按项目统计
- `type_stats`：按测试类型统计

## 5. 业务逻辑

### 5.1 测试单状态流转

测试单状态流转规则：

1. **待评审（wait）** → **正常（normal）**：测试单评审通过
2. **待评审（wait）** → **被阻塞（blocked）**：测试单被阻塞
3. **待评审（wait）** → **研究中（investigate）**：测试单需要研究
4. **正常（normal）** → **被阻塞（blocked）**：测试单被阻塞
5. **正常（normal）** → **研究中（investigate）**：测试单需要研究
6. **被阻塞（blocked）** → **正常（normal）**：测试单解除阻塞
7. **研究中（investigate）** → **正常（normal）**：测试单研究完成

**注意：** 状态流转不是强制的，系统允许直接设置任意状态，但建议遵循上述流转规则。

### 5.2 测试结果记录

测试结果通过 `result` 字段记录：

- **passed**：测试通过
- **failed**：测试失败
- **blocked**：测试被阻塞

**测试结果更新：**

- 测试执行完成后，更新 `result` 字段
- 可以同时更新 `summary` 字段记录测试摘要
- 测试结果用于统计通过率和失败率

### 5.3 测试类型管理

测试类型使用JSON数组存储，支持多选：

- **功能测试（functional）**：测试功能是否正常
- **性能测试（performance）**：测试性能指标
- **安全测试（security）**：测试安全性
- **集成测试（integration）**：测试系统集成
- **单元测试（unit）**：测试单元功能
- **UI测试（ui）**：测试用户界面
- **API测试（api）**：测试API接口
- **其他自定义类型**：可以根据需要添加

**类型筛选：**

- 支持按单个类型筛选测试单
- 支持按多个类型筛选（前端实现）

### 5.4 测试单关联Bug

测试单可以关联多个Bug：

- **关联Bug**：记录测试单发现的Bug
- **关联规则**：一个测试单可以关联多个Bug，一个Bug可以关联多个测试单
- **删除测试单**：删除测试单时，不删除关联的Bug，只删除关联关系

### 5.5 测试统计和覆盖率分析

测试统计包括：

1. **总体统计**：统计测试单总数、各状态数量、通过率、失败率
2. **按项目统计**：按项目统计测试单数量、通过率、失败率
3. **按类型统计**：按测试类型统计测试单数量、通过率、失败率

**通过率计算：**

- 通过率 = 通过的测试单数 / 总测试单数 * 100
- 失败率 = 失败的测试单数 / 总测试单数 * 100

**覆盖率分析（未来扩展）：**

- 需求覆盖率：已测试的需求数 / 总需求数
- 功能覆盖率：已测试的功能数 / 总功能数
- 代码覆盖率：已测试的代码行数 / 总代码行数

## 6. 权限控制

### 6.1 测试单权限

- **test-case:read**：查看测试单列表和详情
- **test-case:create**：创建测试单
- **test-case:update**：更新测试单（包括状态、结果等）
- **test-case:delete**：删除测试单

### 6.2 数据权限

- 普通用户只能查看和操作自己创建或参与的项目中的测试单
- 管理员可以查看和操作所有测试单
- 项目成员可以查看和操作项目中的测试单

## 7. 前端实现

### 7.1 测试单管理页面

- **测试单列表**：支持筛选、搜索、分页
- **测试单详情**：显示测试单完整信息，包括关联的Bug
- **测试单创建/编辑表单**：支持所有字段编辑，支持Markdown编辑器
- **测试单状态切换**：支持快速切换状态
- **测试结果记录**：支持记录测试结果和摘要

### 7.2 测试类型管理

- **类型选择**：支持多选测试类型
- **类型筛选**：支持按类型筛选测试单
- **类型显示**：在测试单列表中显示测试类型标签

### 7.3 测试统计页面

- **总体统计**：显示测试单总数、各状态数量、通过率、失败率
- **按项目统计**：显示各项目的测试统计
- **按类型统计**：显示各类型的测试统计
- **统计图表**：使用图表可视化统计数据

### 7.4 Bug关联管理

- **关联Bug**：支持从Bug列表选择关联到测试单
- **关联展示**：在测试单详情中展示关联的Bug列表
- **Bug跳转**：支持从测试单跳转到Bug详情

## 8. 测试用例

### 8.1 测试单管理测试

1. **创建测试单测试**
   - 测试创建测试单成功
   - 测试必填字段验证
   - 测试测试类型多选
   - 测试关联Bug

2. **更新测试单测试**
   - 测试更新测试单成功
   - 测试状态流转
   - 测试测试结果记录
   - 测试更新关联Bug

3. **删除测试单测试**
   - 测试删除测试单成功
   - 测试删除后关联关系清除

4. **测试单筛选测试**
   - 测试按项目筛选
   - 测试按状态筛选
   - 测试按类型筛选
   - 测试搜索功能

### 8.2 测试统计测试

1. **统计准确性测试**
   - 测试总体统计准确性
   - 测试按项目统计准确性
   - 测试按类型统计准确性
   - 测试通过率和失败率计算

2. **统计筛选测试**
   - 测试按项目筛选统计
   - 测试按关键词筛选统计

### 8.3 Bug关联测试

1. **关联Bug测试**
   - 测试关联Bug成功
   - 测试更新关联关系
   - 测试删除关联关系

## 9. 注意事项

1. **测试类型存储**：测试类型使用JSON数组存储，查询时使用LIKE查询
2. **测试结果统计**：测试结果通过 `result` 字段统计，不是通过 `status` 字段
3. **状态和结果区分**：测试单状态（status）和测试结果（result）是不同的概念
   - 状态：测试单的工作状态（待评审、正常、被阻塞、研究中）
   - 结果：测试执行的结果（通过、失败、阻塞）
4. **权限控制**：确保用户只能访问有权限的项目和测试单
5. **数据完整性**：删除测试单时检查关联关系，确保数据完整性
6. **性能优化**：测试单列表查询时使用预加载（Preload）避免N+1问题
7. **Markdown渲染**：前端正确渲染测试步骤的Markdown内容
8. **类型筛选**：JSON数组字段查询使用LIKE，注意SQL注入防护

## 10. 未来优化

1. **测试报告独立模块**：将测试报告功能独立出来，支持多次测试执行记录
2. **测试计划**：支持创建测试计划，关联多个测试单
3. **测试执行记录**：支持记录每次测试执行的详细信息
4. **测试环境管理**：支持管理测试环境（开发、测试、预发布、生产）
5. **测试数据管理**：支持管理测试数据
6. **自动化测试集成**：支持集成自动化测试工具
7. **测试覆盖率分析**：支持代码覆盖率、需求覆盖率分析
8. **测试报告导出**：支持导出测试报告（PDF、Excel）
9. **测试趋势分析**：支持测试趋势分析，显示测试通过率趋势
10. **测试缺陷分析**：支持测试缺陷分析，分析测试发现的Bug分布

## 11. 测试报告功能（未来扩展）

虽然当前实现中测试报告功能已合并到测试单中，但可以根据需要扩展独立的测试报告模块：

### 11.1 测试报告表（test_reports）

```go
type TestReport struct {
    ID        uint           `gorm:"primarykey" json:"id"`
    CreatedAt time.Time      `json:"created_at"`
    UpdatedAt time.Time      `json:"updated_at"`
    DeletedAt gorm.DeletedAt `gorm:"index" json:"-"`

    TestCaseID uint     `gorm:"index;not null" json:"test_case_id"`
    TestCase   TestCase `gorm:"foreignKey:TestCaseID" json:"test_case,omitempty"`

    Result  string `gorm:"size:20" json:"result"`  // 测试结果：passed, failed, blocked
    Summary string `gorm:"type:text" json:"summary"` // 测试摘要
    Content string `gorm:"type:text" json:"content"` // 测试报告内容（Markdown）

    ExecutorID uint `gorm:"index" json:"executor_id"`
    Executor   User `gorm:"foreignKey:ExecutorID" json:"executor,omitempty"`

    ExecutedAt *time.Time `json:"executed_at"` // 执行时间
}
```

### 11.2 测试报告API

- `GET /api/test-reports`：获取测试报告列表
- `GET /api/test-reports/:id`：获取测试报告详情
- `POST /api/test-reports`：创建测试报告
- `PUT /api/test-reports/:id`：更新测试报告
- `DELETE /api/test-reports/:id`：删除测试报告
- `GET /api/test-cases/:id/reports`：获取测试单的测试报告列表

### 11.3 测试报告功能

- **多次执行记录**：一个测试单可以有多条测试报告，记录多次测试执行
- **执行历史**：查看测试单的测试执行历史
- **最新结果**：测试单显示最新的测试结果
- **报告详情**：每条测试报告包含详细的测试内容

